<% content_for :title, "#{@club.name} - Race Official Controls" %>

<%= turbo_stream_from "club_#{@club.slug}_admin" %>
<%= render "shared/connection_status" %>

<div class="space-y-6" data-controller="counter">
  <!-- Header -->
  <div class="text-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-1"><%= @club.name %></h1>
    <p class="text-gray-600 font-semibold">Race Official Controls</p>
    <%= link_to "‚Üê Public Display", club_race_path(@club.slug), 
                class: "inline-block mt-2 text-blue-600 underline" %>
  </div>

  <!-- Validation Messages -->
  <div id="validation-message">
    <% if @race.at_gate > @race.in_staging %>
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        ‚ö†Ô∏è At Gate cannot be greater than In Staging
      </div>
    <% end %>
  </div>

  <!-- Admin Counters (updates via Turbo Stream) -->
  <div id="admin-counters">
    <%= render "admin_counters", race: @race, club: @club %>
  </div>

  <!-- Enhanced Live Activity Feed -->
  <%= turbo_stream_from "club_#{@club.slug}_admin_activity" %>
  <div id="notifications-panel" class="bg-green-50 border border-green-300 rounded-lg p-5">
    <h3 class="font-semibold text-green-800 mb-3 text-center">
      üì° Live Activity 
      <span id="activity-count" class="ml-2 px-2 py-1 bg-green-200 rounded-full text-xs">
        <%= @club.race_activities.recent.count %>
      </span>
    </h3>
    
    <!-- Real-time activity feed -->
    <div id="activity-feed" class="space-y-2 max-h-48 overflow-y-auto">
      <% @club.race_activities.recent.each do |activity| %>
        <%= render "activity_item", activity: activity %>
      <% end %>
      
      <% if @club.race_activities.recent.empty? %>
        <div class="text-center text-gray-500 text-sm py-4">
          No recent activity
        </div>
      <% end %>
    </div>
    
    <!-- Legacy live notifications for backward compatibility -->
    <div id="live-notifications" class="mt-4 pt-4 border-t border-green-200">
      <%= render "live_notifications", club: @club %>
    </div>
  </div>

  <!-- Race Time Settings -->
  <div id="race-time-settings" class="bg-white border border-gray-300 rounded-lg p-5">
    <%= render "race_time_settings", race_setting: @race_setting, club: @club %>
  </div>

  <!-- Reset Section -->
  <div id="reset-section" class="bg-red-50 border border-red-300 rounded-lg p-5">
    <h3 class="font-semibold text-red-800 mb-4 text-center">‚ö†Ô∏è Reset Counters</h3>
    <p class="text-sm text-red-700 text-center mb-4">Reset operations cannot be undone. Use with caution.</p>
    
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Reset At Gate Only -->
      <div class="text-center">
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Reset 'At Gate' counter to 0? Current value: #{@race.at_gate}" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: @race.in_staging %>
          <%= form.submit "Reset At Gate", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors" %>
        <% end %>
        <p class="text-xs text-red-600 mt-1">Current: <%= @race.at_gate %></p>
      </div>

      <!-- Reset In Staging Only -->
      <div class="text-center">
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Reset 'In Staging' counter to 0? This will also reset 'At Gate' to 0 (business rule). Current staging: #{@race.in_staging}, current at gate: #{@race.at_gate}" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: 0 %>
          <%= form.submit "Reset In Staging", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors" %>
        <% end %>
        <p class="text-xs text-orange-600 mt-1">Current: <%= @race.in_staging %></p>
      </div>

      <!-- Reset Both -->
      <div class="text-center">
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Reset BOTH counters to 0? At Gate: #{@race.at_gate} ‚Üí 0, In Staging: #{@race.in_staging} ‚Üí 0. This cannot be undone!" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: 0 %>
          <%= form.submit "Reset All", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-red-700 hover:bg-red-800 text-white font-bold py-2 px-4 rounded-lg transition-colors" %>
        <% end %>
        <p class="text-xs text-red-700 mt-1">Resets everything</p>
      </div>
    </div>

    <!-- Quick Reset to Common Values -->
    <div class="mt-6 pt-4 border-t border-red-200">
      <h4 class="font-semibold text-red-800 mb-3 text-center">Quick Reset to Common Values</h4>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
        <!-- Reset to 0/5 -->
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Set counters to: At Gate = 0, In Staging = 5?" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: 5 %>
          <%= form.submit "0 / 5", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-2 rounded transition-colors" %>
        <% end %>

        <!-- Reset to 0/10 -->
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Set counters to: At Gate = 0, In Staging = 10?" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: 10 %>
          <%= form.submit "0 / 10", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-2 rounded transition-colors" %>
        <% end %>

        <!-- Reset to 0/15 -->
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Set counters to: At Gate = 0, In Staging = 15?" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: 15 %>
          <%= form.submit "0 / 15", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-2 rounded transition-colors" %>
        <% end %>

        <!-- Reset to 0/20 -->
        <%= form_with model: @race, url: club_race_update_path(@club.slug), 
                      method: :patch, local: false,
                      data: { controller: "confirmation", 
                              confirmation_message_value: "Set counters to: At Gate = 0, In Staging = 20?" } do |form| %>
          <%= form.hidden_field :at_gate, value: 0 %>
          <%= form.hidden_field :in_staging, value: 20 %>
          <%= form.submit "0 / 20", 
                          data: { action: "click->confirmation#confirm" },
                          class: "w-full bg-blue-500 hover:bg-blue-600 text-white text-sm py-2 px-2 rounded transition-colors" %>
        <% end %>
      </div>
      <p class="text-xs text-red-600 text-center mt-2">Format: At Gate / In Staging</p>
    </div>
  </div>
</div>

